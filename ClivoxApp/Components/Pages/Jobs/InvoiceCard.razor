@using ClivoxApp.Models.Invoice
@using System.Globalization

<style>
    .financial-header:hover {
        background-color: var(--mud-palette-action-hover) !important;
    }
    .invoice-card-container {
        cursor: default;
        background-color: var(--mud-palette-surface) !important;
        color: var(--mud-palette-text-primary) !important;
    }
    .financial-header {
        cursor: pointer;
    }
    .expanded-icon {
        background-color: var(--mud-palette-primary-hover) !important;
        border-radius: 50%;
    }
    .date-card {
        background: var(--mud-palette-background-grey) !important;
        color: var(--mud-palette-text-primary) !important;
    }
    .date-card-overdue {
        background: var(--mud-palette-error-lighten) !important;
        color: var(--mud-palette-text-primary) !important;
    }
    .date-card-service {
        background: var(--mud-palette-background-grey) !important;
        color: var(--mud-palette-text-primary) !important;
    }
    .financial-summary-container {
        background: var(--mud-palette-background-grey) !important;
        border: 1px solid var(--mud-palette-table-lines) !important;
    }
    .action-bar {
        background: var(--mud-palette-background-grey) !important;
        border-top: 1px solid var(--mud-palette-table-lines) !important;
    }
    
    /* Theme-aware card styling */
    .invoice-card-container:hover {
        box-shadow: var(--mud-elevation-8) !important;
        transform: translateY(-2px);
        transition: all 0.3s ease !important;
    }
    
    /* Dark theme specific adjustments */
    .mud-theme-dark .invoice-card-container {
        border-color: var(--mud-palette-dark-divider) !important;
    }
    
    .mud-theme-dark .date-card {
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .mud-theme-dark .date-card-overdue {
        background: rgba(244, 67, 54, 0.15) !important;
    }
    
    .mud-theme-dark .date-card-service {
        background: rgba(33, 150, 243, 0.15) !important;
    }
    
    .mud-theme-dark .financial-summary-container {
        background: rgba(255, 255, 255, 0.03) !important;
        border-color: rgba(255, 255, 255, 0.12) !important;
    }
    
    .mud-theme-dark .action-bar {
        background: rgba(255, 255, 255, 0.03) !important;
        border-top-color: rgba(255, 255, 255, 0.12) !important;
    }
</style>

<MudPaper Class="pa-0 invoice-card-container" 
          Elevation="4" 
          Style="border-radius: 20px; overflow: hidden; transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05);"
          @onmouseenter="@(() => _isHovered = true)"
          @onmouseleave="@(() => _isHovered = false)">
    
    <!-- Invoice Header with Status -->
    <div style="background: @GetStatusGradient(Invoice); padding: 24px; color: white; position: relative;">
        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.5;"></div>
        <div style="position: absolute; bottom: -20px; left: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; opacity: 0.7;"></div>
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="position: relative; z-index: 2;">
            <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <MudIcon Icon="@GetStatusIcon(Invoice)" Size="Size.Small" Style="color: white;" />
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">@GetStatusText(Invoice)</MudText>
                </div>
                <MudText Typo="Typo.h5" Style="color: white; font-weight: 700; line-height: 1.2;">@Invoice.InvoiceNumber</MudText>
            </div>
            <div style="text-align: right;">
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8); font-size: 0.7rem;">@Resource.invoiceCard_NetTotal</MudText>
                <div style="background-color: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 12px; backdrop-filter: blur(5px); margin-top: 4px;">
                    <MudText Typo="Typo.body1" Style="color: white; font-weight: 700; font-size: 1rem;">
                        @Invoice.NetTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                    </MudText>
                </div>
            </div>
        </MudStack>
    </div>

    <!-- Invoice Content -->
    <MudCardContent Style="padding: 24px; flex: 1; display: flex; flex-direction: column;">
        <MudStack Spacing="4" Style="flex: 1;">
            <!-- Date Information Grid -->
            <MudGrid>
                <MudItem xs="4">
                    <MudPaper Class="date-card pa-3" Elevation="1" Style="text-align: center; border-radius: 12px;">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Primary" Style="margin-bottom: 4px;" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600; text-transform: uppercase; font-size: 0.7rem;">@Resource.invoiceCard_Issued</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@Invoice.InvoiceDate.ToString("dd MMM")</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="4">
                    <MudPaper Class="@($"{(IsOverdue(Invoice) ? "date-card-overdue" : "date-card")} pa-3")" Elevation="1" Style="text-align: center; border-radius: 12px;">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Color="@(IsOverdue(Invoice) ? Color.Error : Color.Warning)" Style="margin-bottom: 4px;" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600; text-transform: uppercase; font-size: 0.7rem;">@Resource.invoiceCard_Due</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;" Color="@(IsOverdue(Invoice) ? Color.Error : Color.Default)">@Invoice.DueDate.ToString("dd MMM")</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="4">
                    <MudPaper Class="date-card-service pa-3" Elevation="1" Style="text-align: center; border-radius: 12px;">
                        <MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Small" Color="Color.Info" Style="margin-bottom: 4px;" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600; text-transform: uppercase; font-size: 0.7rem;">@Resource.invoiceCard_Service</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@Invoice.ServiceDate.ToString("dd MMM")</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Quick Stats -->
            <MudGrid>
                <MudItem xs="6">
                    <MudPaper Elevation="1" Style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.2) 100%); border-radius: 12px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        <MudIcon Icon="@Icons.Material.Filled.ListAlt" Color="Color.Success" Size="Size.Medium" Style="margin-bottom: 8px;" />
                        <MudText Typo="Typo.h6" Color="Color.Success" Style="font-weight: 700; margin-bottom: 4px;">@Invoice.Items.Count</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Success" Style="font-weight: 600; text-transform: uppercase, font-size: 0.7rem">@(Invoice.Items.Count == 1 ? Resource.invoiceCard_Task : Resource.invoiceCard_Tasks)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Success" Style="font-weight: 600; font-size: 0.7rem; margin-top: 2px;">
                            @Invoice.ItemsTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6">
                    @{
                        var attachmentCount = Invoice.ExpenseProofFiles?.Count ?? 0;
                        var expenseAmount = Invoice.ExpenseProofFiles?.Sum(x => x.Amount) ?? 0;
                    }
                    <MudPaper Elevation="1" Style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.2) 100%); border-radius: 12px; border: 1px solid rgba(255, 152, 0, 0.3);">
                        <MudIcon Icon="@Icons.Material.Filled.Receipt" Color="Color.Warning" Size="Size.Medium" Style="margin-bottom: 8px;" />
                        <MudText Typo="Typo.h6" Color="Color.Warning" Style="font-weight: 700, margin-bottom: 4px">@attachmentCount</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Warning" Style="font-weight: 600, text-transform: uppercase, font-size: 0.7rem">@Resource.invoiceCard_Expenses </MudText>
                        @if (expenseAmount > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Warning" Style="font-weight: 600; font-size: 0.7rem; margin-top: 2px;">
                                @expenseAmount.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Warning" Style="font-weight: 600; font-size: 0.7rem; margin-top: 2px;">
                                @Resource.invoiceCard_NoCosts
                            </MudText>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Financial Breakdown Expander -->
            <MudPaper Class="financial-summary-container" Elevation="1" Style="border-radius: 16px; overflow: hidden;">
                <!-- Expandable Header -->
                <div class="financial-header" 
                     style="padding: 16px; transition: all 0.2s ease; background: transparent;" 
                     @onclick="ToggleFinancialSummary"
                     @onclick:stopPropagation="true">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <MudIcon Icon="@Icons.Material.Filled.Analytics" Color="Color.Primary" Size="Size.Medium" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">@Resource.invoiceCard_FinancialSummary</MudText>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- Quick Net Total Preview -->
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Style="font-weight: 600;">
                                Net: @Invoice.NetTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                            </MudChip>
                            <!-- Expand/Collapse Icon with Click Handler -->
                            <MudIconButton Icon="@(_isFinancialSummaryExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                         Size="Size.Medium" 
                                         Color="Color.Primary"
                                         OnClick="ToggleFinancialSummary"
                                         Class="@(_isFinancialSummaryExpanded ? "expanded-icon" : "")"
                                         Style="transition: transform 0.3s ease;" />
                        </div>
                    </MudStack>
                </div>

                <!-- Collapsible Content -->
                <MudCollapse Expanded="_isFinancialSummaryExpanded">
                    <div style="padding: 0 20px 20px 20px;">
                        <MudStack Spacing="3">
                            <!-- Items Total (Revenue) -->
                            <MudPaper Elevation="1" Style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.2) 100%); border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.3);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Success" />
                                    <MudText Typo="Typo.body2" Color="Color.Success" Style="font-weight: 600;">@Resource.invoiceCard_ItemsTotal</MudText>
                                </div>
                                <MudText Typo="Typo.body1" Color="Color.Success" Style="font-weight: 700;">
                                    @Invoice.ItemsTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                                </MudText>
                            </MudPaper>

                            <!-- Expenses Total (Costs) -->
                            @{
                                var hasExpenses = Invoice.ExpensesTotal > 0;
                            }
                            @if (hasExpenses)
                            {
                                <MudPaper Elevation="1" Style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.2) 100%); border-radius: 8px; border: 1px solid rgba(244, 67, 54, 0.3);">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Small" Color="Color.Error" />
                                        <MudText Typo="Typo.body2" Color="Color.Error" Style="font-weight: 600;">@Resource.invoiceCard_Expenses</MudText>
                                    </div>
                                    <MudText Typo="Typo.body1" Color="Color.Error" Style="font-weight: 700;">
                                        -@Invoice.ExpensesTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                                    </MudText>
                                </MudPaper>
                            }

                            <!-- Divider Line -->
                            <MudDivider />

                            <!-- Net Total (What Client Pays) -->
                            <MudPaper Elevation="2" Style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: linear-gradient(135deg, rgba(25, 118, 210, 0.1) 0%, rgba(25, 118, 210, 0.2) 100%); border-radius: 12px; border: 2px solid rgba(25, 118, 210, 0.5);">
                                <div style="display: flex; align-items: center, gap: 10px;">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Medium" Color="Color.Primary" />
                                    <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">@Resource.invoiceCard_NetTotal</MudText>
                                </div>
                                <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 700;">
                                    @Invoice.NetTotal.ToString("C", CultureInfo.GetCultureInfo("de-DE"))
                                </MudText>
                            </MudPaper>

                            @if (hasExpenses)
                            {
                                <!-- Profit Margin Indicator -->
                                <MudPaper Elevation="1" Style="text-align: center; padding: 8px; border-radius: 8px;">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600; text-transform: uppercase, font-size: 0.7rem;">@Resource.invoiceCard_ProfitMargin</MudText>
                                    @{
                                        var profitMargin = Invoice.ItemsTotal > 0 ? (Invoice.NetTotal / Invoice.ItemsTotal) * 100 : 0;
                                        var profitColor = profitMargin >= 70 ? Color.Success : profitMargin >= 50 ? Color.Warning : Color.Error;
                                    }
                                    <MudText Typo="Typo.body2" Color="@profitColor" Style="font-weight: 700;">@profitMargin.ToString("F1")%</MudText>
                                </MudPaper>
                            }
                        </MudStack>
                    </div>
                </MudCollapse>
            </MudPaper>
        </MudStack>
    </MudCardContent>

    <!-- Enhanced Action Bar -->
    <MudPaper Class="action-bar pa-5" Elevation="0" Style="border-radius: 0;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <!-- Primary Actions -->
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                <MudTooltip Text="@Resource.invoiceCard_EditInvoice">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                 Color="Color.Primary" 
                                 OnClick="@(() => OnEdit.InvokeAsync(Invoice))"
                                 Style="border-radius: 8px 0 0 8px;" />
                </MudTooltip>
                <MudTooltip Text="@Resource.invoiceCard_ManageItems">
                    <MudIconButton Icon="@Icons.Material.Filled.List" 
                                 Color="Color.Primary" 
                                 OnClick="@(() => OnManageItems.InvokeAsync(Invoice))" />
                </MudTooltip>
                <MudTooltip Text="@Resource.invoiceCard_ManageFiles">
                    <MudIconButton Icon="@Icons.Material.Filled.AttachFile" 
                                 Color="Color.Primary" 
                                 OnClick="@(() => OnManageFiles.InvokeAsync(Invoice))" />
                </MudTooltip>
                <MudTooltip Text="@Resource.invoiceCard_DeleteInvoice">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                 Color="Color.Error" 
                                 OnClick="@(() => OnDelete.InvokeAsync(Invoice))"
                                 Style="border-radius: 0 8px 8px 0;" />
                </MudTooltip>
            </MudButtonGroup>

            <!-- Export Actions -->
            <MudStack Row="true" Spacing="1">
                <MudTooltip Text="@Resource.invoiceCard_ExportToExcel">
                    <MudFab StartIcon="@Icons.Material.Filled.TableChart"
                           Color="Color.Success" 
                           Size="Size.Small"
                           OnClick="@(() => OnExportExcel.InvokeAsync(Invoice))"
                           Style="width: 40px; height: 40px;" />
                </MudTooltip>
                <MudTooltip Text="@Resource.invoiceCard_PreviewExportPDF">
                    <MudFab StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           Color="Color.Error" 
                           Size="Size.Small"
                           OnClick="HandlePdfPreview"
                           Style="width: 40px; height: 40px;" />
                </MudTooltip>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudPaper>

@code {
    [Parameter] public Invoice Invoice { get; set; } = null!;
    [Parameter] public EventCallback<Invoice> OnEdit { get; set; }
    [Parameter] public EventCallback<Invoice> OnDelete { get; set; }
    [Parameter] public EventCallback<Invoice> OnManageItems { get; set; }
    [Parameter] public EventCallback<Invoice> OnManageFiles { get; set; }
    [Parameter] public EventCallback<Invoice> OnExportExcel { get; set; }
    [Parameter] public EventCallback<Invoice> OnExportPdf { get; set; }
    [Parameter] public EventCallback<Invoice> OnPreviewPdf { get; set; }

    private bool _isHovered = false;
    private bool _isFinancialSummaryExpanded = false; // Collapsed by default

    private void ToggleFinancialSummary()
    {
        _isFinancialSummaryExpanded = !_isFinancialSummaryExpanded;
        StateHasChanged(); // Force UI update
    }

    private async Task HandlePdfPreview()
    {
        if (OnPreviewPdf.HasDelegate)
        {
            await OnPreviewPdf.InvokeAsync(Invoice);
        }
        else if (OnExportPdf.HasDelegate)
        {
            // Fallback to direct export if preview not available
            await OnExportPdf.InvokeAsync(Invoice);
        }
    }

    private string GetStatusGradient(Invoice invoice)
    {
        if (IsOverdue(invoice))
            return "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)"; // Red for overdue
        
        if (IsDueSoon(invoice))
            return "linear-gradient(135deg, #ff9800 0%, #f57c00 100%)"; // Orange for due soon
        
        return "linear-gradient(135deg, #4CAF50 0%, #45A049 100%)"; // Green for normal
    }

    private string GetStatusIcon(Invoice invoice)
    {
        if (IsOverdue(invoice))
            return Icons.Material.Filled.Warning;
        
        if (IsDueSoon(invoice))
            return Icons.Material.Filled.Schedule;
        
        return Icons.Material.Filled.CheckCircle;
    }

    private string GetStatusText(Invoice invoice)
    {
        if (IsOverdue(invoice))
            return Resource.invoiceCard_Overdue;
        
        if (IsDueSoon(invoice))
            return Resource.invoiceCard_DueSoon;
        
        return Resource.invoiceCard_Current;
    }

    private bool IsOverdue(Invoice invoice)
    {
        return invoice.DueDate < DateTime.Now.Date;
    }

    private bool IsDueSoon(Invoice invoice)
    {
        var daysUntilDue = (invoice.DueDate - DateTime.Now.Date).TotalDays;
        return daysUntilDue <= 7 && daysUntilDue >= 0;
    }
}