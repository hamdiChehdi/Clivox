@using ClivoxApp.Components.Shared
@inherits LayoutComponentBase
@implements IDisposable

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (_isAuthenticated)
{
    <div class="page">
        <div class="sidebar">
            <MudGrid>
                <MudItem xs="3">
                    <MudStack Row="true" Justify="Justify.FlexStart">
                        <MudIconButton Icon="@Icons.Material.Filled.Home" Color="Color.Primary" OnClick="NavigateToHome" Size="Size.Large" Class="mt-2" Style=" height:40px;width:40px;margin-bottom:8px;" />
                        <MudButton StartIcon="@Icons.Material.Filled.AccountBox" Color="Color.Primary" Variant="Variant.Filled" Class="mt-2" Size="Size.Small" OnClick="OpenBusinessOwnerDialog" Style="max-width: 175px">
                            @Resource.businessOwner_Button
                        </MudButton>
                    </MudStack>
                </MudItem>
                <MudItem xs="2">
                    <!-- User Info -->
                    <MudStack Spacing="0" Class="mr-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@Resource.mainLayout_Welcome</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@_currentUserName</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="3">
                </MudItem>
                <MudItem xs="4">
                    <MudStack Row="true">
                        <MudSwitch Value="_isDarkMode"
                                   Color="Color.Primary"
                                   Class="ma-2"
                                   T="bool"
                                   ValueChanged="@(async (bool value) => { _isDarkMode = value; await OnThemeChanged(); })">
                            @if (_isDarkMode)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.DarkMode" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.LightMode" />
                            }
                        </MudSwitch>

                        <!-- Professional Language Switcher -->
                        <LanguageSwitcher CurrentLanguage="@_currentLanguage" OnLanguageChanged="ChangeLanguage" />

                        <!-- Lock Session Button -->
                        <MudTooltip Text="@Resource.mainLayout_LockSession">
                            <MudIconButton Icon="@Icons.Material.Filled.Lock"
                                           Color="Color.Warning"
                                           OnClick="LockSession"
                                           Size="Size.Large" />
                        </MudTooltip>

                        <!-- Logout Button -->
                        <MudTooltip Text="@Resource.mainLayout_Logout">
                            <MudIconButton Icon="@Icons.Material.Filled.Logout"
                                           Color="Color.Error"
                                           OnClick="Logout"
                                           Size="Size.Large" />
                        </MudTooltip>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </div>

        <main>
            <div class="top-row px-4">
            </div>

            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>
}
else if (_showError)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; padding: 20px;">
        <MudCard Style="max-width: 500px; width: 100%;">
            <MudCardContent>
                <MudStack Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Color="Color.Error">@Resource.mainLayout_AuthenticationError</MudText>
                    <MudText Typo="Typo.body1" Style="text-align: center;">@_errorMessage</MudText>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="RetryAuthentication">
                        @Resource.mainLayout_Retry
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </div>
}
else
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <MudStack AlignItems="AlignItems.Center" Spacing="3">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
            <MudText Class="ml-3">@Resource.mainLayout_InitializingAuthentication</MudText>
            @if (!_authenticationCheckCompleted)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @Resource.mainLayout_CheckingDatabase
                </MudText>
            }

            <!-- Temporary test button for login dialog -->
            <MudButton Color="Color.Warning"
                       Variant="Variant.Filled"
                       OnClick="TestShowLoginDialog"
                       Style="margin-top: 20px;">
                @Resource.mainLayout_TestLoginDialog
            </MudButton>
        </MudStack>
    </div>
}
